<p><a href="https://github.com/gustaveroussy/rna-count-kallisto">rna-count-kallisto</a> is a <a href="https://github.com/snakemake-workflows">Snakemake Workflow</a>, it relies on the very same pre-requisites as <a href="https://snakemake.readthedocs.io/">Snakemake</a> itself. Thus, it uses <a href="https://docs.pytest.org/en/latest/">pytest</a> for its continuous testing. In addition, <a href="https://anaconda.org/">Conda</a> is used to power all tools installations and virtual environment management.</p>
<h2 id="install-conda">1. Install conda</h2>
<p>In order to install conda, please follow the guide lines described on the official <a href="https://docs.continuum.io/anaconda/install/">Conda web-page</a>.</p>
<p>This will likely be:</p>
<pre class="{sh}"><code># Conda pre-requisites
apt-get install libgl1-mesa-glx libegl1-mesa libxrandr2 libxrandr2 libxss1 libxcursor1 libxcomposite1 libasound2 libxi6 libxtst6

# Download latest conda installer
wget https://repo.anaconda.com/archive/Anaconda3-2019.03-Linux-x86_64.sh

# Run the installer
bash ~/Downloads/Anaconda3-2019.03-Linux-x86_64.sh</code></pre>
<h2 id="install-snakemake-pre-requisites-within-conda">2. Install Snakemake pre-requisites within Conda</h2>
<p>We are going to use Python 3.7. No other options. Forget about python 2.7, it will be dropped out of support before 2020'. In <a href="https://github.com/gustaveroussy/rna-count-kallisto">rna-count-kallisto</a>, we use <a href="https://docs.python.org/3/library/stdtypes.html#printf-style-string-formatting">formatted strings</a> available at python 3.6. It is not excluded that further development will include python 3.7 exclusive behaviours. Go for latest python !</p>
<p>However, old packages are still not available within <a href="https://pypi.org/">python package installer</a>. Especially, <code>datrie</code> fails to install within Python 3.7 pip module. So we need to install it first, then install Snakemake. That's also why there is not Conda environment for Snakemake with Python 3.7.</p>
<p>Here we go:</p>
<pre class="{sh}"><code># Build virtual environment for Snakemake workflows
conda create -n SnakemakeWorkflows -c conda-forge datrie==0.7.1 python==3.7.3 pytest==4.5.0 git==2.21.0 drmaa==0.7.9

# Activate this environment
conda activate SnakemakeWorkflows

# Install Snakemake with the newly installed python
python3.7 -m pip install snakemake --user</code></pre>
<p>Every single time you will use this pipeline, you have to activate that conda environment. The activation command will not be repeated everywhere in this wiki, so please, don't forget it!</p>
<h2 id="clone-this-workflow">3. Clone this workflow</h2>
<p>The final step to use this workflow is to clone it to your computer. This can be easily done with git (which you have installed in your virtual environment few seconds ago!</p>
<p>Here we go:</p>
<pre class="{sh}"><code>git clone https://github.com/gustaveroussy/rna-count-kallisto.git</code></pre>
<p>Everything is installed. Please, see the next page about <a href="https://github.com/tdayris/rna-splicing-star-leafcutter/wiki/Configuration">configurations</a> before running. You can also see our [test] page if you want to test the <a href="https://github.com/tdayris/rna-splicing-star-leafcutter">rna-splicing-star-leafcutter</a> pipeline.</p>
<p>There are two configuration files: one for your analysis, one for describing your samples. Before each run, both of them are validated : their content is verified thanks to the <a href="https://json-schema.org/">json-shcemas</a>.</p>
<h2 id="the-general-config-file-yaml">1. The general config file (yaml)</h2>
<p>This is a <a href="https://en.wikipedia.org/wiki/YAML">yaml</a> file. It could also be <a href="https://en.wikipedia.org/wiki/JSON">json</a> formatted, however its name must not be changed. Yaml format has been preferred since users requested a more human readable configuration file to write.</p>
<p>This configuration file contains the following sections (in any orders):</p>
<h3 id="ref">ref</h3>
<p>This is a very simple section: two values with evident significations. We need two paths, one to the fasta formatted genome sequence, and one other to the gtf formatted genome annotation. By GTF formatted, I mean GTF. No GFF, no GFF3, no GFF2, no GTF.gz, no GTF.bz2, nothing else than GTF. The same goes with the fasta file.</p>
<p>Example:</p>
<pre><code>ref:
  fasta: path/to/fasta.fa
  gtf: /path/to/gtf.gtf</code></pre>
<p>These paths can be either relative or absolute.</p>
<h3 id="params">params</h3>
<p>This section contains additional command line arguments. One for all, <strong>do not try to modify threading options</strong> here. Do not try to modify neither logging, nor temporary directories. These options are al ready handled.</p>
<p>We have the following values:</p>
<p>copy_extra: Extra parameters for bash cp kallisto_index_extra: Extra parameters for kallisto index rule kallisto_quant_extra: Extra parameters for kallisto quant rule</p>
<p>Example:</p>
<pre><code>params:
  copy_extra: &quot;--parents --verbose&quot;
  kallisto_index_extra: &quot;--make-unique&quot;
  kallisto_quant_extra: &quot;--bias --bootstrap-samples=100&quot;</code></pre>
<h3 id="workflow">workflow</h3>
<p>This section is used to activate or deactivate sections of the pipeline. In fact, if you just want to quantify and no quality control (you may have done them aside of the <a href="https://github.com/gustaveroussy/rna-count-kallisto">rna-count-kallisto</a> pipeline), then turn these flag to <code>false</code> instead of <code>true</code>.</p>
<p>Warning, it is case sensitive!</p>
<p>Example:</p>
<pre><code>workflow:
  fastqc: true
  multiqc: true
  aggregate: true</code></pre>
<h3 id="general">General</h3>
<p>The following parameters do not belong to any section, let them be at the top level of the yaml file:</p>
<p>design: The path to the design file workdir: The path to the working directory threads: The maximum number of threads used singularity_docker_image: The image used within singularity cold_storage: A list of cold storage mount points</p>
<p>Example:</p>
<pre><code>design: design.tsv
workdir: .
threads: 1
singularity_docker_image: docker://continuumio/miniconda3:4.4.10
cold_storage:
  - /media</code></pre>
<h3 id="conclusion">Conclusion</h3>
<p>A complete config.yaml file would look like this:</p>
<pre><code>design: design.tsv
workdir: .
threads: 1
singularity_docker_image: docker://continuumio/miniconda3:4.4.10
cold_storage:
  - /media
ref:
  fasta: /path/to/genome/sequence.fa
  gtf: /path/to/genome/annotaton.gtf
workflow:
  fastqc: true
  multiqc: true
  aggregate: true
params:
  copy_extra: &quot;--parents --verbose&quot;
  kallisto_index_extra: &quot;--make-unique&quot;
  kallisto_quant_extra: &quot;--bias --bootstrap-samples=100&quot;</code></pre>
<p>Remember, there is a python script here to build this file from command line!</p>
<h2 id="the-design-file-tsv">2. The design file (tsv)</h2>
<p>At this stage, we need a <a href="https://en.wikipedia.org/wiki/Tab-separated_values">TSV</a> file describing our analysis.</p>
<p>It must contain the following columns:</p>
<ul>
<li>Sample_id: the name of each samples</li>
<li>Upstream_file: path to the upstream fastq file</li>
</ul>
<p>The optional columns are:</p>
<ul>
<li>Downstream_file: path to downstream fastq files (usually your R2 in paired-end libraries)</li>
<li>Any other information</li>
</ul>
<p>Remember, there is a python script here to build this file from command line!</p>
<h2 id="local-usage">Local usage</h2>
<p>Here is your command line:</p>
<pre><code>snakemake</code></pre>
<p>Yes. Nothing more as long as you hav <a href="https://www.bioinformatics.babraham.ac.uk/projects/fastqc/">FastQC</a>, <a href="https://multiqc.info/">MultiQC</a> and <a href="https://pachterlab.github.io/kallisto/">Kallisto</a> in your <code>PATH</code>.</p>
<p>However, conda provides an efficient way to dynamically build virtual environments and to double check your tool versions, that's why we recommend:</p>
<pre><code>snakemake --use-conda</code></pre>
<p>And if you want to be sure that your OS is not interfering with your run, then use:</p>
<pre><code>snakemake --use-conda --singularity</code></pre>
<p>I won't detail more of the Snakemake possibilities, please see <a href="https://snakemake.readthedocs.io/en/stable/executable.html">their documentation</a>. However, many users like the following:</p>
<pre><code>snakemake --use-conda --singularity --reason --printshellcmds</code></pre>
<p>With these supplementary arguments, you will have the executed command lines printed to your STDOUT, and each rule will give you the reason why it is being executed. Nice, isn't it ?</p>
<h2 id="pbs-torque">PBS Torque</h2>
<p>In addition to the previous arguments, one might want to use this pipeline on a PBS Torque cluster.</p>
<pre><code>snakemake --cluster &quot; qsub -l walltime=00:{resources.time_min}:00,nodes=1:ppn={threads},mem={resources.mem_mb}mb -V &quot; --jobname &quot;{rulename}.snakejob.{jobid}&quot; --use-conda --reason --printshellcmds --jobs 20  --restart-times 3</code></pre>
<h2 id="slurm">Slurm</h2>
<pre><code>snakemake --use-conda --reason --printshellcmds --configfile config.yaml --cluster &quot;sbatch --mem={resources.mem_mb}M --cpus-per-task={threads} --time={resources.time_min}&quot; --restart-times 3 --jobs 20</code></pre>
<h2 id="global-workflow">Global workflow</h2>
<p>This workflows takes fastq files, genome sequences and annotations as input, and returns abundance estimates along side with optional quality metrics.</p>
<h2 id="fastqc">FastQC</h2>
<p><a href="https://www.bioinformatics.babraham.ac.uk/projects/fastqc/">FastQC</a> stands for FastQ Quality Control. There is no publication associated with this tool, however, it remains an inescapable classic in bioinformatics.</p>
<p>This tool compiles a lot of informations about the raw reads obtained from sequencers. Actually, this tool does not perform any process <strong>required</strong> for the whole splicing analysis; however, it's a good practice.</p>
<p>Citation: * Andrews, Simon. &quot;FastQC: a quality control tool for high throughput sequence data.&quot; (2010).</p>
<h2 id="multiqc">MultiQC</h2>
<p><a href="https://multiqc.info/">MultiQC</a>, just like FastQC, do not have any other purpose than quality metrics. It gathers all Flagstat and all FastQC individual metrics into one single report.</p>
<p>Citation: * Ewels, Philip, et al. &quot;MultiQC: summarize analysis results for multiple tools and samples in a single report.&quot; Bioinformatics 32.19 (2016): 3047-3048.</p>
<h2 id="kallisto">Kallisto</h2>
<p><a href="https://pachterlab.github.io/kallisto/">Kallisto</a> is a program for quantifying abundances of transcripts from RNA-Seq data. It is based on pseudoalignment for rapidly determining the compatibility of reads with targets, without the need for alignment. Pseudoalignment of reads preserves the key information needed for quantification, and kallisto is therefore not only fast, but also as accurate as existing quantification tools. In fact, because the pseudoalignment procedure is robust to errors in the reads, in many benchmarks kallisto significantly outperforms existing tools.</p>
<p>Citation: * Nicolas L Bray, Harold Pimentel, Páll Melsted and Lior Pachter, Near-optimal probabilistic RNA-seq quantification, Nature Biotechnology 34, 525–527 (2016), doi:10.1038/nbt.3519</p>
<h2 id="snakemake">Snakemake</h2>
<p><a href="https://snakemake.readthedocs.io">Snakemake</a> is a pipeline/workflow manager written in python. It is used to handle the tools interaction, dependencies, command lines and cluster reservation. It is the skeleton of this pipeline. This pipeline is powered by the <a href="https://snakemake-wrappers.readthedocs.io">Snakemake-Wrappers</a>, the <a href="https://github.com/snakemake-workflows">Snakemake Workflows</a>, and the <a href="https://anaconda.org">conda</a> project.</p>
<p>Citation: * Köster, Johannes, and Sven Rahmann. &quot;Snakemake—a scalable bioinformatics workflow engine.&quot; Bioinformatics 28.19 (2012): 2520-2522.</p>
